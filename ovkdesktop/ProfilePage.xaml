<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="ovkdesktop.ProfilePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:ovkdesktop"
    xmlns:models="using:ovkdesktop.Models"
    xmlns:converters="using:ovkdesktop.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:StringToMediaPlaybackSourceConverter x:Key="StringToMediaPlaybackSourceConverter"/>
        <converters:IntToColorConverter x:Key="LikeButtonColorConverter"/>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Профиль пользователя (аватар и информация) -->
        <Grid Grid.Row="0" Margin="125,105,20,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Аватар пользователя -->
            <PersonPicture Grid.Column="0" 
                          x:Name="ProfileAvatar" 
                          Width="120" Height="120"
                          VerticalAlignment="Top"/>
            
            <!-- Информация о пользователе -->
            <StackPanel Grid.Column="1" Margin="20,0,0,0">
                <TextBlock x:Name="ProfileName" 
                          Text="Загрузка..." 
                          Style="{ThemeResource TitleLargeTextBlockStyle}" 
                          FontSize="32"/>
                
                <TextBlock x:Name="PostsCountText" 
                          Text="Загрузка постов..." 
                          Opacity="0.7" 
                          Style="{ThemeResource BodyTextBlockStyle}"
                          Margin="0,5,0,15"/>
                
                <TextBlock x:Name="ErrorTextBlock" 
                          Foreground="Red" 
                          Visibility="Collapsed" 
                          TextWrapping="Wrap"
                          Margin="0,0,0,10"/>
                
                <!-- Кнопки действий -->
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Button Content="Опубликовать пост" Click="PublishNewPostButton"/>
                    <Button Content="Отредактировать профиль"/>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- Список постов -->
        <Grid Grid.Row="1" Margin="110,20,20,20" x:Name="GridPostsMyProfile">
            <ProgressRing x:Name="LoadingProgressRing" 
                         IsActive="True" 
                         Width="50" Height="50" 
                         HorizontalAlignment="Center" 
                         VerticalAlignment="Center"/>

            <ListView x:Name="PostsListView" 
                     ItemsSource="{x:Bind Posts}"
                     HorizontalAlignment="Stretch">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:UserWallPost">
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                               BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                               BorderThickness="1" CornerRadius="8"
                               Margin="0,5,0,10" Padding="15"
                               HorizontalAlignment="Stretch">
                            <Grid HorizontalAlignment="Stretch">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- Дата поста -->
                                <TextBlock Grid.Row="0"
                                          Text="{Binding FormattedDate}"
                                          Opacity="0.7" Margin="0,0,0,10"/>

                                <!-- Текст поста -->
                                <TextBlock Grid.Row="1"
                                          Text="{Binding Text}"
                                          TextWrapping="Wrap" Margin="0,0,0,10"
                                          Foreground="{ThemeResource TextFillColorPrimary}"/>

                                <!-- Изображение -->
                                <Image Grid.Row="2"
                                      Source="{Binding MainImageUrl}"
                                      Stretch="Uniform" MaxHeight="400"
                                      HorizontalAlignment="Left" Margin="0,0,0,10"
                                      Visibility="{Binding HasImage, Converter={StaticResource BoolToVisibilityConverter}}"/>

                                <!-- Видео -->
                                <Grid Grid.Row="3" 
                                     Visibility="{Binding HasVideo, Converter={StaticResource BoolToVisibilityConverter}}"
                                     Margin="0,0,0,10"
                                     HorizontalAlignment="Left">
                                    <MediaPlayerElement 
                                        Source="{Binding MainVideo.Player, Converter={StaticResource StringToMediaPlaybackSourceConverter}}"
                                        MaxHeight="400" 
                                        AreTransportControlsEnabled="True"/>
                                </Grid>

                                <!-- GIF -->
                                <Image Grid.Row="4"
                                      Source="{Binding GifUrl}"
                                      Stretch="Uniform" MaxHeight="400"
                                      HorizontalAlignment="Left" Margin="0,0,0,10"
                                      Visibility="{Binding HasGif, Converter={StaticResource BoolToVisibilityConverter}}"/>

                                <!-- Аудио -->
                                <ItemsControl Grid.Row="5"
                                             ItemsSource="{Binding Audios}"
                                             Visibility="{Binding HasAudio, Converter={StaticResource BoolToVisibilityConverter}}"
                                             Margin="0,0,0,10"
                                             HorizontalAlignment="Stretch">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="models:Audio">
                                            <Grid Height="60" Margin="0,5" HorizontalAlignment="Stretch">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="40"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <!-- Кнопка воспроизведения -->
                                                <Button Grid.Column="0" Width="40" Height="40" 
                                                        Padding="0" Background="Transparent"
                                                        Tag="{Binding}" Click="PlayAudio_Click">
                                                    <FontIcon Glyph="&#xE768;" FontSize="16"/>
                                                </Button>
                                                
                                                <!-- Информация о треке -->
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="5,0,0,0">
                                                    <TextBlock Text="{Binding Title}" 
                                                               TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                                                               FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding Artist}" 
                                                               TextWrapping="NoWrap" TextTrimming="CharacterEllipsis"
                                                               Opacity="0.8" FontSize="12"/>
                                                </StackPanel>
                                                
                                                <!-- Длительность -->
                                                <TextBlock Grid.Column="2" Text="{Binding FormattedDuration}" 
                                                           VerticalAlignment="Center" Margin="10,0,0,0"
                                                           Opacity="0.8" FontSize="12"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Репост -->
                                <Border Grid.Row="6" 
                                       Visibility="{Binding HasRepost, Converter={StaticResource BoolToVisibilityConverter}}"
                                       Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                                       BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                       BorderThickness="1" CornerRadius="4"
                                       Padding="10" Margin="0,0,0,10"
                                       HorizontalAlignment="Stretch">
                                    <StackPanel>
                                        <!-- Repost author header with avatar and info -->
                                        <Grid Margin="0,0,0,10">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- Author avatar -->
                                            <Ellipse Grid.Column="0" Width="36" Height="36" Margin="0,0,10,0">
                                                <Ellipse.Fill>
                                                    <ImageBrush ImageSource="{Binding Repost.Profile.Photo200}" 
                                                                Stretch="UniformToFill"/>
                                                </Ellipse.Fill>
                                            </Ellipse>
                                            
                                            <!-- Author info -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <!-- Clickable repost owner text -->
                                                <Button x:Name="RepostAuthorButton"
                                                        Background="Transparent" 
                                                        BorderThickness="0"
                                                        Padding="0,2" 
                                                        Margin="0,0,0,0"
                                                        HorizontalAlignment="Left"
                                                        HorizontalContentAlignment="Left"
                                                        Tag="{Binding Repost.FromId}"
                                                        Click="RepostAuthor_Click">
                                                    <TextBlock Text="{Binding RepostOwnerText}" 
                                                              Opacity="1.0" 
                                                              Margin="0,0,0,0"
                                                              Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                                              FontWeight="SemiBold"/>
                                                </Button>
                                                
                                                <!-- Post date -->
                                                <TextBlock Text="{Binding Repost.FormattedDate}"
                                                           Opacity="0.7" 
                                                           FontSize="12"/>
                                            </StackPanel>
                                        </Grid>
                                        
                                        <!-- Repost content -->
                                        <TextBlock Text="{Binding Repost.Text}" 
                                                  TextWrapping="Wrap" Margin="0,0,0,10"
                                                  Foreground="{ThemeResource TextFillColorPrimary}"/>
                                        
                                        <Image Source="{Binding Repost.MainImageUrl}"
                                              Stretch="Uniform" MaxHeight="300"
                                              HorizontalAlignment="Left" Margin="0,0,0,10"
                                              Visibility="{Binding Repost.HasImage, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                              
                                        <Image Source="{Binding Repost.GifUrl}"
                                              Stretch="Uniform" MaxHeight="300"
                                              HorizontalAlignment="Left" Margin="0,0,0,10"
                                              Visibility="{Binding Repost.HasGif, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                              
                                        <Grid Visibility="{Binding Repost.HasVideo, Converter={StaticResource BoolToVisibilityConverter}}"
                                             Margin="0,0,0,0"
                                             HorizontalAlignment="Left">
                                            <MediaPlayerElement 
                                                Source="{Binding Repost.MainVideo.Player, Converter={StaticResource StringToMediaPlaybackSourceConverter}}"
                                                MaxHeight="300" 
                                                AreTransportControlsEnabled="True"/>
                                        </Grid>
                                    </StackPanel>
                                </Border>

                                <!-- Лайки и комментарии -->
                                <StackPanel Grid.Row="6" 
                                          Orientation="Horizontal" 
                                          Spacing="15" 
                                          Margin="0,20,0,0"
                                          VerticalAlignment="Bottom">
                                    <!-- Кнопка лайка -->
                                    <Button Tag="{Binding}" 
                                            Click="LikeButton_Click" 
                                            Background="Transparent" 
                                            BorderThickness="0" 
                                            Padding="5,2">
                                        <StackPanel Orientation="Horizontal" Spacing="5">
                                            <TextBlock Text="❤" />
                                            <TextBlock Text="{Binding Likes.Count, FallbackValue=0, TargetNullValue=0}" 
                                                       Foreground="{Binding Likes.UserLikes, Converter={StaticResource LikeButtonColorConverter}, FallbackValue=Black}"/>
                                        </StackPanel>
                                    </Button>

                                    <!-- Кнопка комментариев -->
                                    <Button Tag="{Binding}" 
                                            Tapped="ShowPostComments_Tapped" 
                                            Background="Transparent" 
                                            BorderThickness="0" 
                                            Padding="5,2">
                                        <StackPanel Orientation="Horizontal" Spacing="5">
                                            <TextBlock Text="💬" />
                                            <TextBlock Text="{Binding Comments.Count, FallbackValue=0, TargetNullValue=0}" 
                                                       VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>
        
        <!-- Фрейм для навигации -->
        <Frame x:Name="ContentProfileFrame" Grid.RowSpan="2">
            <Frame.ContentTransitions>
                <TransitionCollection>
                    <NavigationThemeTransition />
                </TransitionCollection>
            </Frame.ContentTransitions>
        </Frame>
    </Grid>
</Page>